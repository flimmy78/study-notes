<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Blog Name</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/header.js"></script>
  <script src="/js/toc.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/theme.css" rel="stylesheet">
  <link href="/css/syntax.css" rel="stylesheet">
  <link href="/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Blog Name</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="/">/home</a></li>
          <li><a href="/archive.html">/archive</a></li>
          <li><a href="/tags.html">/tags</a></li>
          <li><a href="/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="/2016/06/aosp_compile">Aosp_compile</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>26 Jun 2016</time>
                </div>
                <ul>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <p>(in progress)</p>

<h2 id="get-aosp">1. get aosp</h2>
<p>### 1.0. aosp 源代码获取  <br />
大陆，被墙，可以使用两个国内源 <br />
清华 <code class="highlighter-rouge">http://mirrors.tuna.tsinghua.edu.cn/</code><br />
中科大 <code class="highlighter-rouge">https://lug.ustc.edu.cn/wiki/mirrors/help/aosp</code></p>

<p><code class="highlighter-rouge">git clone git://aosp.tuna.tsinghua.edu.cn/android/git-repo.git/</code></p>

<p>修改repo<br />
google的地址<br />
<code class="highlighter-rouge">REPO_URL = 'https://gerrit.googlesource.com/git-repo'</code><br />
改为清华大学的地址<br />
<code class="highlighter-rouge">REPO_URL = ‘git://aosp.tuna.tsinghua.edu.cn/android/git-repo'</code></p>

<p>从清华源获取某个版本<br />
<code class="highlighter-rouge">repo init -u  git://aosp.tuna.tsinghua.edu.cn/android/platform/manifest -b android-5.1.1_r6</code><br />
或者全部版本<br />
<code class="highlighter-rouge">repo init -u git://aosp.tuna.tsinghua.edu.cn/android/platform/manifest</code></p>

<p><code class="highlighter-rouge">repo sync</code> 会同做所有到.repo</p>

<p><code class="highlighter-rouge">repo sync -c</code> 只下载当前分支（清华同一个源不能超过4个连接,中科大不超过5个）</p>

<p>从中科大源获取<br />
<code class="highlighter-rouge">repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest</code><br />
or<br />
<code class="highlighter-rouge">repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-4.0.1_r1</code></p>

<h3 id="sdk">1.1. sdk</h3>
<p>东软的源 <a href="http://mirrors.neusoft.edu.cn/">link</a><br />
启动 Android SDK Manager ，打开主界面，依次选择「Tools」、「Options…」，弹出『Android SDK Manager - Settings』窗口；<br />
在『Android SDK Manager - Settings』窗口中，在「HTTP Proxy Server」和「HTTP Proxy Port」输入框内填入mirrors.neusoft.edu.cn和80，并且选中「Force https://… sources to be fetched using http://…」复选框。设置完成后单击「Close」按钮关闭『Android SDK Manager - Settings』窗口返回到主界面；<br />
依次选择「Packages」、「Reload」。</p>

<h2 id="repo">2. repo</h2>
<p>### 2.0.<br />
查看可切换的分支</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd .repo/manifests
git branch -a | cut -d / -f 3
</code></pre>
</div>
<p>以 gingerbread-release 分支为例<br />
<code class="highlighter-rouge">
repo init -b gingerbread-release 
repo sync (not needed if your local copy is up to date)
repo start gingerbread-release --all 
#查看当前的分支
repo branches
</code><br />
—</p>

<p>所有的资源都在.repo 下， 切换分支前最好删除当前除了git-repo，.repo 的文件，然后repo sync -c ，否则可能因为有改动无法切换，sync -c 此时很快，所有东西都在.repo下</p>

<hr />

<h3 id="section">2.1.</h3>
<p>repo只是google用Python脚本写的调用git的一个脚本，主要是用来下载、管理Android项目的软件仓库。</p>

<p>下载 repo 的地址: http://android.git.kernel.org/repo ，可以用 wget http://android.git.kernel.org/repo 或者 curl http://android.git.kernel.org/repo &gt;~/bin/repo  来下载 repo , chmod a+x ~/bin/repo <br />
用repo sync 在抓去 android source code 的时候，会经常出现一些错误导致 repo sync 中断，每次都要手动开始。 可以用如下的命令，来自动重复：   $?=1;   while [ $? -ne 0 ] ; do  repo sync ; done<br />
 repo help [ command ] , 显示command 的详细的帮助信息内容<br />
repo init -u URL ,  在当前目录安装 repository ，会在当前目录创建一个目录 “.repo”  -u 参数指定一个URL， 从这个URL 中取得repository 的 manifest 文件。   repo init -u git://android.git.kernel.org/platform/manifest.git<br />
               可以用 -m 参数来选择 repository 中的某一个特定的 manifest 文件，如果不具体指定，那么表示为默认的 namifest 文件 (default.xml)    repo init -u git://android.git.kernel.org/platform/manifest.git -m dalvik-plus.xml</p>

<div class="highlighter-rouge"><pre class="highlight"><code>          可以用 -b 参数来指定某个manifest 分支。

           repo init -u git://android.git.kernel.org/platform/manifest.git -b release-1.0

          可以用命令: repo help init 来获取 repo init 的其他用法

    4. repo sync [project-list]

        下载最新本地工作文件，更新成功，这本地文件和repository 中的代码是一样的。 可以指定需要更新的project ， 如果不指定任何参数，会同步整个所有的项目。

       如果是第一次运行 repo sync ， 则这个命令相当于 git clone ，会把 repository 中的所有内容都拷贝到本地。 如果不是第一次运行 repo sync ， 则相当于 git remote update ;  git rebase origin/branch .  repo sync 会更新 .repo 下面的文件。 如果在merge 的过程中出现冲突， 这需要手动运行  git  rebase --continue

  5. repo update[ project-list ]

  上传修改的代码 ，如果你本地的代码有所修改，那么在运行 repo sync 的时候，会提示你上传修改的代码，所有修改的代码分支会上传到 Gerrit (基于web 的代码review 系统), Gerrit 受到上传的代码，会转换为一个个变更，从而可以让人们来review 修改的代码。

   6. repo diff [ project-list ]

    显示提交的代码和当前工作目录代码之间的差异。

   7. repo download  target revision

    下载特定的修改版本到本地， 例如:  repo download pltform/frameworks/base 1241 下载修改版本为 1241 的代码

   8. repo start newbranchname

    创建新的branch分支。 "." 代表当前工作的branch 分支。

   9.  repo prune [project list]

    删除已经merge 的 project

  10. repo foreach [ project-lists] -c command

   对每一个 project 运行 command 命令

  11. repo status

   显示 project 的状态
</code></pre>
</div>

<h2 id="compile">3. compile</h2>
<p>### 3.0. 配置编译环境</p>

<p>$ sudo apt-get install git-core gnupg flex bison gperf build-essential   zip curl libc6-dev libncurses5-dev x11proto-core-dev    libx11-dev libreadline6-dev libgl1-mesa-glx  libgl1-mesa-dev g++-multilib mingw32 tofrodos    python-markdown libxml2-utils xsltproc zlib1g-dev lib32readline6-dev ia32-dev</p>

<p>配置ccache</p>

<p>export USE_CCACHE=1<br />
export export CCACHE_DIR=/mnt/ccache/ar<br />
prebuilts/misc/linux-x86/ccache/ccache -M 50G</p>

<h3 id="section-1">3.1. 编译</h3>

<p>source build/envsetup.sh<br />
lunch<br />
make</p>

<p>问题：<br />
  1. make -jN ，N 越大，速度越快，占用内存越多<br />
  2. ccahe：prebuild 预留了ccahe，提高编译速度，减少重新编译的时间</p>

<h3 id="section-2">3.2. 自定义</h3>
<ul>
  <li>定义自己的产品编译项，
    <ol>
      <li>
        <p>创建公司目录</p>

        <p>#mkdir vendor/farsight</p>
      </li>
      <li>
        <p>创建一个vendorsetup.sh文件，将当前产品编译项添加到lunch里，让lunch能找到用户个性定制编译项</p>

        <p>#echo “add_lunch_combo fs100-eng” &gt; vendor/farsight/vendorsetup.sh</p>
      </li>
      <li>
        <p>仿着Android示例代码，在公司目录下创建products目录</p>

        <p>#mkdir -p vendor/farsight/products</p>
      </li>
      <li>
        <p>仿着Android示例代码，在products目录下创建两个mk文件</p>

        <p>#touch vendor/farsight/products/AndroidProduct.mk vendor/farsight/products/fs100.mk</p>
      </li>
    </ol>
  </li>
</ul>

<p>在AndroidProduct.mk里添加如下内容：</p>

<ul>
  <li>
    <p>board cfg<br />
build/core/main.mk包含了config.mk，它主要定义了编译全部代码的依赖关系</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>build/core/config.mk         定义了大量的编译脚本命令，编译时用到的环境变量，引入了envsetup.mk 文件，加载board相关配置文件。
build/core/envsetup.mk   定义了编译时用到的大量OUT输出目录，加载product_config.mk文件
build/core/product_config.mk 定义了Vendor目录下Product相关配置文件解析脚本，读取AndrodProducts.mk生成TARGET_DEVICE变量
build/target/product          product config
build/target/board            board config
build/core/combo             build flags config  
</code></pre>
    </div>
  </li>
</ul>

<p>PRODUCT_MAKEFILES := $(LOCAL_DIR)/fs100.mk<br />
表示只有一个产品fs100，它对应的配置文件在当前目录下的fs100.mk。</p>

<ul>
  <li>
    <p>borad主要是设计到硬件芯片的配置，比如是否提供硬件的某些功能，比如说GPU等等，或者芯片支持浮 点运算等等。product是指针对当前的芯片配置定义你将要生产产品的个性配置，主要是指APK方面的配置，哪些APK会包含在哪个product中， 哪些APK在当前product中是不提供的。</p>

    <ol>
      <li>在vendor目录下创建自己公司目录，然后在公司目录下创建一个新的vendorsetup.sh，在里面添加上自己的产品编译项</li>
    </ol>

    <p>$mkdir vendor/farsight/  <br />
$touch vendor/farsight/vendorsetup.sh  <br />
$echo “add_lunch_combo fs100-eng” &gt; vendor/farsight/vendorsetup.sh</p>

    <ol>
      <li>仿着Android示例代码，在公司目录下创建products目录<br />
 $mkdir -p vendor/farsight/products</li>
      <li>仿着Android示例代码，在products目录下创建两个mk文件<br />
$touch vendor/farsight/products/AndroidProduct.mk vendor/farsight/products/fs100.mk<br />
 在AndroidProduct.mk里添加如下内容：<br />
PRODUCT_MAKEFILES := $(LOCAL_DIR)/fs100.mk  <br />
 在产品配置文件里添加最基本信息</li>
    </ol>

    <p>PRODUCT_PACKAGES := \  <br />
     IM \  <br />
     VoiceDialer     <br />
 $(call inherit-product, build/target/product/generic.mk)     <br />
 # Overrides  <br />
 PRODUCT_MANUFACTURER := farsight  <br />
 PRODUCT_NAME := fs100  <br />
 PRODUCT_DEVICE := fs100</p>

    <ol>
      <li>借鉴build/target/board/generic/AndroidBoard.mk和BoardConfig.mk，创建对应文件。<br />
$cp build/target/board/generic/AndroidBoard.mk build/target/board/generic/BoardConfig.mk  vendor/farsight/fs100/</li>
    </ol>
  </li>
</ul>

<h2 id="problem">5.problem</h2>
<p>### 5.0.<br />
Android repo 出现error.GitError: manifests rev-list (‘^12303f87b9f90c07bf4aec4c4353ba514ee70c8a’, ‘HEAD’, ‘–’): fatal: bad revision ‘HEAD’<br />
执行的操作<br />
repo init -u git://192.168.1.183/android/platform/manifest.git -b android-4.2.1_r1.2<br />
或者<br />
repo init -b android-4.2.1_r1.2<br />
出现问题<br />
Traceback (most recent call last): File “/work/information/source_code/google/abc/.repo/repo/main.py”, line 414, in <module> _Main(sys.argv[1:]) File "/work/information/source_code/google/abc/.repo/repo/main.py", line 390, in _Main result = repo._Run(argv) or 0 File "/work/information/source_code/google/abc/.repo/repo/main.py", line 138, in _Run result = cmd.Execute(copts, cargs) File "/work/information/source_code/google/abc/.repo/repo/subcmds/init.py", line 347, in Execute self._SyncManifest(opt) File "/work/information/source_code/google/abc/.repo/repo/subcmds/init.py", line 203, in _SyncManifest m.Sync_LocalHalf(syncbuf) File "/work/information/source_code/google/abc/.repo/repo/project.py", line 1120, in Sync_LocalHalf upstream_gain = self._revlist(not_rev(HEAD), revid) File "/work/information/source_code/google/abc/.repo/repo/project.py", line 2006, in _revlist return self.work_git.rev_list(*a, **kw) File "/work/information/source_code/google/abc/.repo/repo/project.py", line 2155, in rev_list p.stderr)) error.GitError: manifests rev-list ('^HEAD', '4c2be345d6bfc25db87f23749912ae9d98d2ad62', '--'): fatal: bad revision '^HEAD'</module></p>

<p>解决方案<br />
删除.repo 目录下的 除 repo 文件夹之外的其它所有文件，重新执行inti和sync<br />
可以执行： rm -rf .repo/manifest*</p>

<h3 id="section-3">5.1.</h3>
<p>target SharedLib: libwebviewchromium (out/target/product/generic/obj/SHARED_LIBRARIES/libwebviewchromium_intermediates/LINKED/libwebviewchromium.so) collect2: error: ld terminated with signal 9 [Killed</p>

<p>make: *** [out/target/product/generic/obj/SHARED_LIBRARIES/libwebviewchromium_intermediates/LINKED/libwebviewchromium.so] Error 1</p>

<p>出错原因：swap 分区不足<br />
解决办法：增加swap 分区</p>

                

              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2016/07/kernel_initcall">Kernel_initcall</a></li>
    
    <li><a href="/2016/07/linux_netstack">Linux_netstack</a></li>
    
    <li><a href="/2016/07/kernel_init">Kernel_init</a></li>
    
    <li><a href="/2016/07/intercept_syscall">Intercept_syscall</a></li>
    
    <li><a href="/2016/07/uboot-net">Uboot Net</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    

  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Pavel Makhov &copy; 2015</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="streetturtle on Github" href="https://github.com/streetturtle" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title=" on StackOverflow" href="http://stackoverflow.com/users/" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  

  
    <li>
      <a title=" on Instagram" href="https://instagram.com/" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title=" on Last.fm" href="http://lastfm.com/user/" target="_blank"><i class="fa fa-lastfm fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="feed.xml RSS" href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
