<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Ezio's Notes</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/study-notes/js/jquery.min.js"></script>
  <script src="/study-notes/js/bootstrap.min.js"></script>
  <script src="/study-notes/js/header.js"></script>
  <script src="/study-notes/js/toc.js"></script>
  <link href="/study-notes/css/bootstrap.min.css" rel="stylesheet">
  <link href="/study-notes/css/theme.css" rel="stylesheet">
  <link href="/study-notes/css/syntax.css" rel="stylesheet">
  <link href="/study-notes/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/study-notes/">Ezio's Notes</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="/study-notes/">/home</a></li>
          <li><a href="/study-notes/archive.html">/archive</a></li>
          <li><a href="/study-notes/tags.html">/tags</a></li>
          <li><a href="/study-notes/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="/study-notes/2016/07/uboot%E7%9A%84shell">Uboot的shell</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>02 Jul 2016</time>
                </div>
                <ul>
                  
                    <li><a href="/study-notes/tags.html#u-boot">u-boot</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h1 id="uboot-shell-">uboot shell 命令</h1>

<h2 id="uboot-shell--1">4. uboot shell 命令的实现</h2>

<h3 id="section">4.1. 添加命令</h3>

<p>以命令 <code class="highlighter-rouge">boot</code> 为例（<code class="highlighter-rouge">cmd/bootm.c</code>），添加该命令使用了下面的语句：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>U_BOOT_CMD(
    boot,   1,  1,  do_bootd,
    "boot default, i.e., run 'bootcmd'",
    ""
);
</code></pre>
</div>

<p>这段语句可以这么理解：给 uboot 添加了一条 shell 命令 <code class="highlighter-rouge">boot</code>，它的作用是引导、启动操作系统(<code class="highlighter-rouge">boot default, i.e., run 'bootcmd'</code>)，实现命令的函数是 <code class="highlighter-rouge">do_bootd</code>。</p>

<p>之所以这么一条语句就可以完成添加 shell 命令，可以参考 U_BOOT_CMD 的实现：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#define U_BOOT_CMD(_name, _maxargs, _rep, _cmd, _usage, _help)      \
    U_BOOT_CMD_COMPLETE(_name, _maxargs, _rep, _cmd, _usage, _help, NULL)
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>#define U_BOOT_CMD_COMPLETE(_name, _maxargs, _rep, _cmd, _usage, _help, _comp) \
    ll_entry_declare(cmd_tbl_t, _name, cmd) =           \
        U_BOOT_CMD_MKENT_COMPLETE(_name, _maxargs, _rep, _cmd,  \
                        _usage, _help, _comp);
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>#define ll_entry_declare(_type, _name, _list)               \
    _type _u_boot_list_2_##_list##_2_##_name __aligned(4)       \
            __attribute__((unused,              \
            section(".u_boot_list_2_"#_list"_2_"#_name)))
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>#define U_BOOT_CMD_MKENT_COMPLETE(_name, _maxargs, _rep, _cmd,      \
                _usage, _help, _comp)           \
        { #_name, _maxargs, _rep, _cmd, _usage,         \
            _CMD_HELP(_help) _CMD_COMPLETE(_comp) }
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code># define _CMD_HELP(x) x,
# define _CMD_COMPLETE(x) x,
</code></pre>
</div>

<p>通过逐层解析宏 <code class="highlighter-rouge">U_BOOT_CMD</code>，最终会得到：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cmd_tbl_t _u_boot_list_2_cmd_2_boot __aligned(4) __attribute__((unused, section(".u_boot_list_2_cmd_2_boot"))) = {
        `boot`,
        1,
        1,
        do_bootd,
        "boot default, i.e., run 'bootcmd'",
        "",
        };


</code></pre>
</div>

<p>在 u-boot.lds 中会链接 .u_boot_list_2_cmd_2_boot ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>. = ALIGN(4);
.u_boot_list : {
 KEEP(*(SORT(.u_boot_list*)));
}
</code></pre>
</div>

<p>注：其中 SORT 会按照名称的的顺序进行链接。</p>

<p>cmd_tbl_t 定义如下(成员变量 complete 暂不讨论)：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct cmd_tbl_s    cmd_tbl_t;
struct cmd_tbl_s {
    char        *name;      /* Command Name         */
    int         maxargs;    /* maximum number of arguments  */
    int         repeatable; /* autorepeat allowed?      */
                    /* Implementation function  */
    int         (*cmd)(struct cmd_tbl_s *, int, int, char * const []);
    char        *usage;     /* Usage message    (short) */
#ifdef  CONFIG_SYS_LONGHELP
    char        *help;      /* Help  message    (long)  */
#endif
#ifdef CONFIG_AUTO_COMPLETE
    /* do auto completion on the arguments */
    int     (*complete)(int argc, char * const argv[], char last_char, int maxv, char *cmdv[]);
#endif
};
</code></pre>
</div>

<p>综上，  <code class="highlighter-rouge">U_BOOT_CMD(...)</code> 实际上是定义了一个结构体变量，这个结构体定义了 uboot 的 shell 命令要用到的信息，并且这个结构体变量是保存在指定的位置（<code class="highlighter-rouge">section(".u_boot_list_2_cmd_2_boot")</code>)。 uboot 运行时会主动在该 section 寻找命令并执行。</p>

<h3 id="section-1">4.2. 执行命令</h3>

<p>uboot 的 shell 入口是 <code class="highlighter-rouge">common/board_r.c</code> 的 run_main_loop() :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static int run_main_loop(void)
{
#ifdef CONFIG_SANDBOX
    sandbox_main_loop_init();
#endif
    /* main_loop() can return to retry autoboot, if so just run it again */
    for (;;)
        main_loop();
    return 0;
}
</code></pre>
</div>

<p><code class="highlighter-rouge">main_loop()</code> 会重复执行，处理输入的命令</p>

<p><code class="highlighter-rouge">common/main.c</code> 的 main_loop ：<br />
```<br />
/* We come here after U-Boot is initialised and ready to process commands */<br />
void main_loop(void)<br />
{<br />
    const char *s;</p>

<p>…<br />
    cli_init();<br />
…<br />
    s = bootdelay_process();<br />
    if (cli_process_fdt(&amp;s))<br />
        cli_secure_boot_cmd(s);</p>

<div class="highlighter-rouge"><pre class="highlight"><code>autoboot_command(s);

cli_loop(); ... } ```
</code></pre>
</div>

<p>其中 <code class="highlighter-rouge">cli_loop()</code> 是执行命令的具体函数 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>void cli_loop(void)
{
...
    parse_file_outer();
    /* This point is never reached */
    for (;;);
...
}
</code></pre>
</div>

<p><code class="highlighter-rouge">parse_file_outer()</code> 会调用 <code class="highlighter-rouge">parse_stream_outer()</code> 解析输入的命令并调用 run_list() 执行命令 :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static int parse_stream_outer(struct in_str *inp, int flag)
{
...
    do {
        ...
            run_list(ctx.list_head);
...
    /* loop on syntax errors, return on EOF */
    } while (rcode != -1 &amp;&amp; !(flag &amp; FLAG_EXIT_FROM_LOOP) &amp;&amp;
        (inp-&gt;peek != static_peek || b_peek(inp)));
...
}
</code></pre>
</div>

<p>接着顺着函数调用链 <code class="highlighter-rouge">run_list() -&gt; run_list_real() -&gt; run_pipe_real() -&gt; cmd_process()</code> uboot 进入到 cmd_process() 开始准备执行命令。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>enum command_ret_t cmd_process(int flag, int argc, char * const argv[],
                   int *repeatable, ulong *ticks)
{
    enum command_ret_t rc = CMD_RET_SUCCESS;
    cmd_tbl_t *cmdtp;

    /* Look up command in command table */
    cmdtp = find_cmd(argv[0]);
    if (cmdtp == NULL) {
        printf("Unknown command '%s' - try 'help'\n", argv[0]);
        return 1;
    }

    /* found - check max args */
    if (argc &gt; cmdtp-&gt;maxargs)
        rc = CMD_RET_USAGE;

#if defined(CONFIG_CMD_BOOTD)
    /* avoid "bootd" recursion */
    else if (cmdtp-&gt;cmd == do_bootd) {
        if (flag &amp; CMD_FLAG_BOOTD) {
            puts("'bootd' recursion detected\n");
            rc = CMD_RET_FAILURE;
        } else {
            flag |= CMD_FLAG_BOOTD;
        }
    }
#endif

    /* If OK so far, then do the command */
    if (!rc) {
        if (ticks)
            *ticks = get_timer(0);
        rc = cmd_call(cmdtp, flag, argc, argv);
        if (ticks)
            *ticks = get_timer(*ticks);
        *repeatable &amp;= cmdtp-&gt;repeatable;
    }
    if (rc == CMD_RET_USAGE)
        rc = cmd_usage(cmdtp);
    return rc;
}
</code></pre>
</div>

<p>其中 <code class="highlighter-rouge">find_cmd()</code> 用来在保存命令的 <code class="highlighter-rouge">u_boot_list*</code> 段内寻找命令对应的结构体变量，然后 <code class="highlighter-rouge">cmd_call()</code> 调用结构体变量对应的函数，到此命令执行完成。</p>

<h3 id="section-2">4.3. 命令解析</h3>

<p>命令解析有三部分：输入命令、找到命令、执行命令。</p>

<h4 id="section-3">4.3.1. 输入命令</h4>

<p>uboot shell 的命令都是通过串口输入的，s用户输入字符串后会由 uboot 对字符串进行解析，最终获得命令、命令参数。</p>

<h4 id="section-4">4.3.2. 找到命令</h4>

<p>通过串口输入获取到命令名称和命令参数后，要在 section .u_boot_list_2_cmd_2* 找到命令的结构体变量，根据结构体变量调用命令背后的函数。</p>

<p>寻找命令的函数是 <code class="highlighter-rouge">cmd_tbl_t *find_cmd()</code> ，函数返回了对应的命令结构体变量 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cmd_tbl_t *find_cmd(const char *cmd)
{
    cmd_tbl_t *start = ll_entry_start(cmd_tbl_t, cmd);
    const int len = ll_entry_count(cmd_tbl_t, cmd);
    return find_cmd_tbl(cmd, start, len);
}
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>#define ll_entry_start(_type, _list)                    \
({                                  \
    static char start[0] __aligned(4) __attribute__((unused,    \
        section(".u_boot_list_2_"#_list"_1")));         \
    (_type *)&amp;start;                        \
})
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>#define ll_entry_count(_type, _list)                    \
    ({                              \
        _type *start = ll_entry_start(_type, _list);        \
        _type *end = ll_entry_end(_type, _list);        \
        unsigned int _ll_result = end - start;          \
        _ll_result;                     \
    })
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>#define ll_entry_end(_type, _list)                  \
({                                  \
    static char end[0] __aligned(4) __attribute__((unused,      \
        section(".u_boot_list_2_"#_list"_3")));         \
    (_type *)&amp;end;                          \
})
</code></pre>
</div>

<p>而命令的结构体变量 <code class="highlighter-rouge">.u_boot_list_2_*_2*</code> 正好位于 <code class="highlighter-rouge">.u_boot_list_2_"#_list"_1"</code> 和 <code class="highlighter-rouge">.u_boot_list_2_"#_list"_3"</code> 之间，这样就获取到了 <code class="highlighter-rouge">.u_boot_list_2_*_2*</code> 的长度，然后调用函数 <code class="highlighter-rouge">find_cmd_tbl()</code> 遍历该 section 、寻找命令对应的结构体变量并返回给 shell。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cmd_tbl_t *find_cmd_tbl(const char *cmd, cmd_tbl_t *table, int table_len)
{
...
    for (cmdtp = table; cmdtp != table + table_len; cmdtp++) {
        if (strncmp(cmd, cmdtp-&gt;name, len) == 0) {
            if (len == strlen(cmdtp-&gt;name))
                return cmdtp;   /* full match */

            cmdtp_temp = cmdtp; /* abbreviated command ? */
            n_found++;
        }
    }
...
}
</code></pre>
</div>

<h4 id="section-5">4.3.3. 执行命令</h4>

<p>cmd_process() 调用 cmd_call() 执行命令，很简单就是直接调用命令结构体变量的成员函数 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static int cmd_call(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
{
   ...
    result = (cmdtp-&gt;cmd)(cmdtp, flag, argc, argv);
   ....
}
</code></pre>
</div>


                

              </div>
              
            </div>
            <!-- JiaThis Button BEGIN -->
            <div class="jiathis_style">
                    <span class="jiathis_txt">分享到：</span>
                        <a class="jiathis_button_qzone">QQ空间</a>
                            <a class="jiathis_button_tsina">新浪微博</a>
                                <a class="jiathis_button_tqq">腾讯微博</a>
                                    <a class="jiathis_button_pocket">Pocket</a>
                                        <a class="jiathis_button_evernote">EverNote</a>
                                            <a class="jiathis_button_linkedin">LinkedIn</a>
                                                <a class="jiathis_button_fb">Facebook</a>
                                                    <a class="jiathis_button_weixin">微信</a>
                                                        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
                                                            <a class="jiathis_counter_style"></a>
            </div>
            <script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
            <!-- JiaThis Button END -->
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/study-notes/2016/07/%E5%BC%80%E5%A7%8B%E8%AE%A4%E7%9C%9F%E5%86%99%E7%AC%94%E8%AE%B0">开始认真写笔记</a></li>
    
    <li><a href="/study-notes/2016/07/%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8%E7%9A%84initcall">内核启动的initcall</a></li>
    
    <li><a href="/study-notes/2016/07/linux%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%88%86%E6%9E%90">Linux网络协议栈分析</a></li>
    
    <li><a href="/study-notes/2016/07/kernel%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">Kernel初始化流程</a></li>
    
    <li><a href="/study-notes/2016/07/linux%E4%B8%8B%E6%8B%A6%E6%88%AA%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95">Linux下拦截系统调用的一种方法</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="/study-notes/tag/工具">工具</a></li>
    
      <li><a href="/study-notes/tag/git">git</a></li>
    
      <li><a href="/study-notes/tag/shell">shell</a></li>
    
      <li><a href="/study-notes/tag/vagrant">vagrant</a></li>
    
      <li><a href="/study-notes/tag/ARM">ARM</a></li>
    
      <li><a href="/study-notes/tag/开发板">开发板</a></li>
    
      <li><a href="/study-notes/tag/beaglebone">beaglebone</a></li>
    
      <li><a href="/study-notes/tag/PPC">PPC</a></li>
    
      <li><a href="/study-notes/tag/android">android</a></li>
    
      <li><a href="/study-notes/tag/Knowledge">Knowledge</a></li>
    
      <li><a href="/study-notes/tag/个人">个人</a></li>
    
      <li><a href="/study-notes/tag/C/C++">C/C++</a></li>
    
      <li><a href="/study-notes/tag/Linux">Linux</a></li>
    
      <li><a href="/study-notes/tag/net">net</a></li>
    
      <li><a href="/study-notes/tag/RaspberryPi">RaspberryPi</a></li>
    
      <li><a href="/study-notes/tag/RTOS">RTOS</a></li>
    
      <li><a href="/study-notes/tag/u-boot">u-boot</a></li>
    
      <li><a href="/study-notes/tag/文件系统">文件系统</a></li>
    
      <li><a href="/study-notes/tag/协议栈">协议栈</a></li>
    
      <li><a href="/study-notes/tag/驱动">驱动</a></li>
    
      <li><a href="/study-notes/tag/Kernel">Kernel</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    

  </div>

      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Ezio &copy; 2016</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="oska874 on Github" href="https://github.com/oska874" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="1294322 on StackOverflow" href="http://stackoverflow.com/users/1294322" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="oska874 on LinkedIn" href="https://www.linkedin.com/in/zhang-lei-1b41b669" target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
    </li>
  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/study-notes/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
