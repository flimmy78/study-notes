<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Ezio's Notes</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/study-notes/js/jquery.min.js"></script>
  <script src="/study-notes/js/bootstrap.min.js"></script>
  <script src="/study-notes/js/header.js"></script>
  <script src="/study-notes/js/toc.js"></script>
  <link href="/study-notes/css/bootstrap.min.css" rel="stylesheet">
  <link href="/study-notes/css/theme.css" rel="stylesheet">
  <link href="/study-notes/css/syntax.css" rel="stylesheet">
  <link href="/study-notes/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/study-notes/">Ezio's Notes</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="/study-notes/">/home</a></li>
          <li><a href="/study-notes/archive.html">/archive</a></li>
          <li><a href="/study-notes/tags.html">/tags</a></li>
          <li><a href="/study-notes/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="/study-notes/2016/07/uboot%E5%9F%BA%E7%A1%80">Uboot基础</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>02 Jul 2016</time>
                </div>
                <ul>
                  
                    <li><a href="/study-notes/tags.html#u-boot">u-boot</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h1 id="uboot-">uboot 基础</h1>

<p>(使用的uboot 版本：<code class="highlighter-rouge">u-boot-2016.07-rc1</code>)</p>

<!-- MarkdownTOC -->

<ul>
  <li>
    <ol>
      <li>make 命令</li>
    </ol>
  </li>
  <li>
    <ol>
      <li>添加自定义的开发板配置文件</li>
    </ol>
  </li>
</ul>

<!-- /MarkdownTOC -->

<h2 id="make-">1. make 命令</h2>

<p>详细命令可以使用 <code class="highlighter-rouge">make help</code> 或者文件 README 获取：</p>

<p>```<br />
  ➜  u-boot-2016.05  make help<br />
Cleaning targets:<br />
  clean           - Remove most generated files but keep the config<br />
  mrproper        - Remove all generated files + config + various backup files<br />
  distclean       - mrproper + remove editor backup and patch files</p>

<p>Configuration targets:<br />
  config          - Update current config utilising a line-oriented program<br />
  nconfig         - Update current config utilising a ncurses menu based program<br />
  menuconfig      - Update current config utilising a menu based program<br />
  xconfig         - Update current config utilising a QT based front-end<br />
  gconfig         - Update current config utilising a GTK based front-end<br />
  oldconfig       - Update current config utilising a provided .config as base<br />
  localmodconfig  - Update current config disabling modules not loaded<br />
  localyesconfig  - Update current config converting local mods to core<br />
  silentoldconfig - Same as oldconfig, but quietly, additionally update deps<br />
  defconfig       - New config with default from ARCH supplied defconfig<br />
  savedefconfig   - Save current config as ./defconfig (minimal config)<br />
  allnoconfig     - New config where all options are answered with no<br />
  allyesconfig    - New config where all options are accepted with yes<br />
  allmodconfig    - New config selecting modules when possible<br />
  alldefconfig    - New config with all symbols set to default<br />
  randconfig      - New config with random answer to all options<br />
  listnewconfig   - List new options<br />
  olddefconfig    - Same as silentoldconfig but sets new symbols to their default value</p>

<p>Other generic targets:<br />
  all             - Build all necessary images depending on configuration<br />
* u-boot          - Build the bare u-boot<br />
  dir/            - Build all files in dir and below<br />
  dir/file.[oisS] - Build specified target only<br />
  dir/file.lst    - Build specified mixed source/assembly target only<br />
                    (requires a recent binutils and recent build (System.map))<br />
  tags/ctags      - Generate ctags file for editors<br />
  etags           - Generate etags file for editors<br />
  cscope          - Generate cscope index<br />
  ubootrelease    - Output the release version string (use with make -s)<br />
  ubootversion    - Output the version stored in Makefile (use with make -s)</p>

<p>Static analysers<br />
  checkstack      - Generate a list of stack hogs</p>

<p>Documentation targets:<br />
 U-Boot bootloader internal documentation in different formats:<br />
  htmldocs        - HTML<br />
  pdfdocs         - PDF<br />
  psdocs          - Postscript<br />
  xmldocs         - XML DocBook<br />
  mandocs         - man pages<br />
  installmandocs  - install man pages generated by mandocs<br />
  cleandocs       - clean all generated DocBook files</p>

<p>make V=0|1 [targets] 0 =&gt; quiet build (default), 1 =&gt; verbose build<br />
  make V=2   [targets] 2 =&gt; give reason for rebuild of target<br />
  make O=dir [targets] Locate all output files in “dir”, including .config<br />
  make C=1   [targets] Check all c source with $CHECK (sparse by default)<br />
  make C=2   [targets] Force check of all c source with $CHECK<br />
  make RECORDMCOUNT_WARN=1 [targets] Warn about ignored mcount sections<br />
  make W=n   [targets] Enable extra gcc checks, n=1,2,3 where<br />
                1: warnings which may be relevant and do not occur too often<br />
                2: warnings which occur quite often but may still be relevant<br />
                3: more obscure warnings, can most likely be ignored<br />
                Multiple levels can be combined with W=12 or W=123</p>

<p>Execute “make” or “make all” to build all targets marked with [*]<br />
For further info see the ./README file<br />
  ```</p>

<p>其实常用到的命令就 4 个： <code class="highlighter-rouge">make xxx_defconfig</code> 、 <code class="highlighter-rouge">make clean</code> 、 <code class="highlighter-rouge">make mrproper</code> 、 <code class="highlighter-rouge">make -j N</code>, 注意：<br />
    - 如果不是编译 x86 的 uboot，还需要显式的指出 <code class="highlighter-rouge">ARCH</code> 和 <code class="highlighter-rouge">CROSS_COMPILE</code> ， 可以在执行 make 时附带 <code class="highlighter-rouge">ARCH=xxx CROSS_COMPILE=yyy</code> 编译，也可以设置环境变量（<code class="highlighter-rouge">export ARCH=xxx</code>)。<br />
    - xxx_defconfig 和你的目标板有关，比如 beaglebone black 的配置文件是 am335x_boneblack_defconfig，具体的配置文件名称可以在目录 <code class="highlighter-rouge">configs</code>（新版 uboot）或者文件 <code class="highlighter-rouge">boards.cfg</code> (旧版 uboot） 下找到。</p>

<h3 id="make-menuconfig">1.1. make menuconfig</h3>

<p>新版的 u-boot 可以像 kernel 一样使用 menuconfig 配置参数（最新版的一定可以）</p>

<p><code class="highlighter-rouge">
  make menuconfig
 </code></p>

<p>效果图：</p>

<p>```</p>

<p>.config - U-Boot 2016.05 Configuration<br />
 ──────────────────────────────────────────────────────────────────────────────<br />
  ┌───────────────────── U-Boot 2016.05 Configuration ──────────────────────┐<br />
  │  Arrow keys navigate the menu.  <Enter> selects submenus ---&gt; (or empty │
  │  submenus ----).  Highlighted letters are hotkeys.  Pressing <Y>        │
  │  includes, <N> excludes, <M> modularizes features.  Press <Esc><Esc> to │
  │  exit, &lt;?&gt; for Help, &lt;/&gt; for Search.  Legend: [*] built-in  [ ]         │
  │ ┌─────────────────────────────────────────────────────────────────────┐ │
  │ │        Architecture select (ARM architecture)  ---&gt;                 │ │
  │ │        ARM architecture  ---&gt;                                       │ │
  │ │        General setup  ---&gt;                                          │ │
  │ │        Boot images  ---&gt;                                            │ │
  │ │        Boot timing  ---&gt;                                            │ │
  │ └────┴(+)─────────────────────────────────────────────────────────────┘ │
  ├─────────────────────────────────────────────────────────────────────────┤
  │        <select>    &lt; Exit &gt;    &lt; Help &gt;    &lt; Save &gt;    &lt; Load &gt;         │
  └─────────────────────────────────────────────────────────────────────────┘</select></Esc></Esc></M></N></Y></Enter></p>

<p>```</p>

<p>注意，终端最小得是 80*19 大小。</p>

<h3 id="sandbox-">1.2. sandbox 镜像</h3>

<p>如果没有合适的运行环境（开发板）运行 uboot 镜像，可以编译 sandbox 版的 uboot ， 这样就可以想运行程序一样运行 uboot 镜像 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>make sandbox_defconfig
make
./u-boot -d u-boot.dtb

(type 'reset' to exit U-Boot)

</code></pre>
</div>

<p>启动后和普通的 uboot 一样 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜  u-boot-2016.07-rc2 ./u-boot -d u-boot.dtb


U-Boot 2016.07-rc2 (Jul 02 2016 - 11:11:15 +0800)

DRAM:  128 MiB
MMC:   
Using default environment

In:    cros-ec-keyb
Out:   vidconsole
Err:   vidconsole
SCSI:  Net:   eth0: eth@10002000, eth1: eth@80000000, eth5: eth@90000000
IDE:   Bus 0: not available  
=&gt; 
</code></pre>
</div>

<p>注意编译 sandbox 版的 uboot 需要主机支持 sdl ，ubuntu 下 <code class="highlighter-rouge">sudo apt-get install libsdl1.2-dev</code> 即可。</p>

<h4 id="test">1.2.1. test</h4>

<p>执行脚本 <code class="highlighter-rouge">./test/py/test.py --bd sandbox --build -k ut_dm -v</code> 可以测试 driver model 。</p>

<p>注意： 1. 测试程序依赖 python 2.7 和 pytest ，需要手动安装；<br />
2. 执行时要保证 uboot 没有被编译过（可以用 <code class="highlighter-rouge">make mrproer</code> 清理一下），否则会报错。</p>

<p>执行结果：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜  u-boot-2016.07-rc2 ./test/py/test.py --bd sandbox --build -k ut_dm -v
+make O=/workspace/repos/src/u-boot-2016.07-rc2/build-sandbox -s sandbox_defconfig
+make O=/workspace/repos/src/u-boot-2016.07-rc2/build-sandbox -s -j8
In file included from tools/common/image-fit.c:1:
../tools/../common/image-fit.c:1691:39: warning: use of logical '||' with constant operand [-Wconstant-logical-operand]
        os_ok = image_type == IH_TYPE_FLATDT || IH_TYPE_FPGA ||
                                             ^  ~~~~~~~~~~~~
../tools/../common/image-fit.c:1691:39: note: use '|' for a bitwise operation
        os_ok = image_type == IH_TYPE_FLATDT || IH_TYPE_FPGA ||
                                             ^~
                                             |
1 warning generated.
===================== WARNING ======================
This board uses CONFIG_DM_I2C_COMPAT. Please remove
(possibly in a subsequent patch in your series)
before sending patches to the mailing list.
====================================================
===================================================================== test session starts =====================================================================
platform linux2 -- Python 2.7.11+, pytest-2.9.2, py-1.4.31, pluggy-0.3.1 -- /usr/bin/python
cachedir: .cache
rootdir: /workspace/repos/src/u-boot-2016.07-rc2, inifile: 
collected 206 items 

test/py/tests/test_ut.py::test_ut_dm_init PASSED
test/py/tests/test_ut.py::test_ut[ut_dm_adc_bind] PASSED
test/py/tests/test_ut.py::test_ut[ut_dm_adc_multi_channel_conversion] PASSED
test/py/tests/test_ut.py::test_ut[ut_dm_adc_multi_channel_shot] PASSED
test/py/tests/test_ut.py::test_ut[ut_dm_adc_single_channel_conversion] PASSED
test/py/tests/test_ut.py::test_ut[ut_dm_adc_single_channel_shot] PASSED
...
</code></pre>
</div>

<p>（<strong>test 实现后续补充，可以借鉴到一般的嵌入式软件开发测试</strong>）</p>

<h2 id="section">2. 添加自定义的开发板配置文件</h2>

<p>按照 <code class="highlighter-rouge">xxx_defconfig</code> 这样的名称在 configs 目录下创建文件即可。</p>

<p>（in progress）</p>

                

              </div>
              
            </div>
            <!-- JiaThis Button BEGIN -->
            <div class="jiathis_style">
                    <span class="jiathis_txt">分享到：</span>
                        <a class="jiathis_button_qzone">QQ空间</a>
                            <a class="jiathis_button_tsina">新浪微博</a>
                                <a class="jiathis_button_tqq">腾讯微博</a>
                                    <a class="jiathis_button_pocket">Pocket</a>
                                        <a class="jiathis_button_evernote">EverNote</a>
                                            <a class="jiathis_button_linkedin">LinkedIn</a>
                                                <a class="jiathis_button_fb">Facebook</a>
                                                    <a class="jiathis_button_weixin">微信</a>
                                                        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
                                                            <a class="jiathis_counter_style"></a>
            </div>
            <script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
            <!-- JiaThis Button END -->
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/study-notes/2016/07/%E5%BC%80%E5%A7%8B%E8%AE%A4%E7%9C%9F%E5%86%99%E7%AC%94%E8%AE%B0">开始认真写笔记</a></li>
    
    <li><a href="/study-notes/2016/07/%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8%E7%9A%84initcall">内核启动的initcall</a></li>
    
    <li><a href="/study-notes/2016/07/linux%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%88%86%E6%9E%90">Linux网络协议栈分析</a></li>
    
    <li><a href="/study-notes/2016/07/kernel%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">Kernel初始化流程</a></li>
    
    <li><a href="/study-notes/2016/07/linux%E4%B8%8B%E6%8B%A6%E6%88%AA%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95">Linux下拦截系统调用的一种方法</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="/study-notes/tag/工具">工具</a></li>
    
      <li><a href="/study-notes/tag/git">git</a></li>
    
      <li><a href="/study-notes/tag/shell">shell</a></li>
    
      <li><a href="/study-notes/tag/vagrant">vagrant</a></li>
    
      <li><a href="/study-notes/tag/ARM">ARM</a></li>
    
      <li><a href="/study-notes/tag/开发板">开发板</a></li>
    
      <li><a href="/study-notes/tag/beaglebone">beaglebone</a></li>
    
      <li><a href="/study-notes/tag/PPC">PPC</a></li>
    
      <li><a href="/study-notes/tag/android">android</a></li>
    
      <li><a href="/study-notes/tag/Knowledge">Knowledge</a></li>
    
      <li><a href="/study-notes/tag/个人">个人</a></li>
    
      <li><a href="/study-notes/tag/C/C++">C/C++</a></li>
    
      <li><a href="/study-notes/tag/Linux">Linux</a></li>
    
      <li><a href="/study-notes/tag/net">net</a></li>
    
      <li><a href="/study-notes/tag/RaspberryPi">RaspberryPi</a></li>
    
      <li><a href="/study-notes/tag/RTOS">RTOS</a></li>
    
      <li><a href="/study-notes/tag/u-boot">u-boot</a></li>
    
      <li><a href="/study-notes/tag/文件系统">文件系统</a></li>
    
      <li><a href="/study-notes/tag/协议栈">协议栈</a></li>
    
      <li><a href="/study-notes/tag/驱动">驱动</a></li>
    
      <li><a href="/study-notes/tag/Kernel">Kernel</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    

  </div>

      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Ezio &copy; 2016</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="oska874 on Github" href="https://github.com/oska874" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="1294322 on StackOverflow" href="http://stackoverflow.com/users/1294322" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="oska874 on LinkedIn" href="https://www.linkedin.com/in/zhang-lei-1b41b669" target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
    </li>
  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/study-notes/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
