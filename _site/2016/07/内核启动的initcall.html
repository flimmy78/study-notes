<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Ezio's Notes</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/study-notes/js/jquery.min.js"></script>
  <script src="/study-notes/js/bootstrap.min.js"></script>
  <script src="/study-notes/js/header.js"></script>
  <script src="/study-notes/js/toc.js"></script>
  <link href="/study-notes/css/bootstrap.min.css" rel="stylesheet">
  <link href="/study-notes/css/theme.css" rel="stylesheet">
  <link href="/study-notes/css/syntax.css" rel="stylesheet">
  <link href="/study-notes/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/study-notes/">Ezio's Notes</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="/study-notes/">/home</a></li>
          <li><a href="/study-notes/archive.html">/archive</a></li>
          <li><a href="/study-notes/tags.html">/tags</a></li>
          <li><a href="/study-notes/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="/study-notes/2016/07/%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8%E7%9A%84initcall">内核启动的initcall</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>06 Jul 2016</time>
                </div>
                <ul>
                  
                    <li><a href="/study-notes/tags.html#Linux">Linux</a></li>
                  
                    <li><a href="/study-notes/tags.html#Kernel">Kernel</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h1 id="initcall">initcall</h1>

<!-- MarkdownTOC -->

<ul>
  <li>
    <ol>
      <li>initcall 定义</li>
    </ol>
  </li>
  <li>
    <ol>
      <li>initcall 的执行</li>
    </ol>
  </li>
</ul>

<!-- /MarkdownTOC -->

<h2 id="initcall-">1. initcall 定义</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>#define early_initcall(fn)      __define_initcall(fn, early)
#define pure_initcall(fn)       __define_initcall(fn, 0)

#define core_initcall(fn)       __define_initcall(fn, 1)
#define core_initcall_sync(fn)      __define_initcall(fn, 1s)
#define postcore_initcall(fn)       __define_initcall(fn, 2)
#define postcore_initcall_sync(fn)  __define_initcall(fn, 2s)
#define arch_initcall(fn)       __define_initcall(fn, 3)
#define arch_initcall_sync(fn)      __define_initcall(fn, 3s)
#define subsys_initcall(fn)     __define_initcall(fn, 4)
#define subsys_initcall_sync(fn)    __define_initcall(fn, 4s)
#define fs_initcall(fn)         __define_initcall(fn, 5)
#define fs_initcall_sync(fn)        __define_initcall(fn, 5s)
#define rootfs_initcall(fn)     __define_initcall(fn, rootfs)
#define device_initcall(fn)     __define_initcall(fn, 6)
#define device_initcall_sync(fn)    __define_initcall(fn, 6s)
#define late_initcall(fn)       __define_initcall(fn, 7)
#define late_initcall_sync(fn)      __define_initcall(fn, 7s)
</code></pre>
</div>

<p>最终都是通过 <code class="highlighter-rouge">__define_initcall</code> 实现的 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#define __define_initcall(fn, id) \
    static initcall_t __initcall_##fn##id __used \
    __attribute__((__section__(".initcall" #id ".init"))) = fn
</code></pre>
</div>

<p>也就是说经过 <code class="highlighter-rouge">*_initcall</code> 修饰的函数最终都会按照顺序放到 section <code class="highlighter-rouge">.initcall#id#.init</code> 中，然后kernel 会按照顺序执行这些函数。</p>

<p>而在 <code class="highlighter-rouge">include/asm-generic/vmlinux.lds.h</code> 里面已经定义好了对应的 section ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#define INIT_DATA_SECTION(initsetup_align)              \
    .init.data : AT(ADDR(.init.data) - LOAD_OFFSET) {       \
        INIT_DATA                       \
        INIT_SETUP(initsetup_align)             \
        INIT_CALLS                      \
        CON_INITCALL                        \
        SECURITY_INITCALL                   \
        INIT_RAM_FS                     \
    }
#define VMLINUX_SYMBOL(x) __VMLINUX_SYMBOL(x)

#define INIT_CALLS_LEVEL(level)                     \
        VMLINUX_SYMBOL(__initcall##level##_start) = .;      \
        *(.initcall##level##.init)              \
        *(.initcall##level##s.init)             \

#define INIT_CALLS                          \
        VMLINUX_SYMBOL(__initcall_start) = .;           \
        *(.initcallearly.init)                  \
        INIT_CALLS_LEVEL(0)                 \
        INIT_CALLS_LEVEL(1)                 \
        INIT_CALLS_LEVEL(2)                 \
        INIT_CALLS_LEVEL(3)                 \
        INIT_CALLS_LEVEL(4)                 \
        INIT_CALLS_LEVEL(5)                 \
        INIT_CALLS_LEVEL(rootfs)                \
        INIT_CALLS_LEVEL(6)                 \
        INIT_CALLS_LEVEL(7)                 \
        VMLINUX_SYMBOL(__initcall_end) = .;

</code></pre>
</div>

<p>最终编译内核使用 lds 链接脚本 <code class="highlighter-rouge">$(arch)/kernel/vmlinux.lds</code> 中就有：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>INIT_DATA_SECTION(...)
</code></pre>
</div>

<h2 id="initcall--1">2. initcall 的执行</h2>

<p>kernel 启动过程中会执行 <code class="highlighter-rouge">init/main.c</code> 的 <code class="highlighter-rouge">start_kernel()</code>，然后按照下面的调用链最终会调用 <code class="highlighter-rouge">do_initcalls()</code> 执行这些初始化函数：</p>

<p><code class="highlighter-rouge">start_kernel()</code>-&gt;<code class="highlighter-rouge">rest_init()</code>-&gt;<code class="highlighter-rouge">kernel_thread(kernel_init)</code>-&gt;<code class="highlighter-rouge">kernel_init_freeable()</code>-&gt;<code class="highlighter-rouge">do_basic_setup()</code>-&gt;<code class="highlighter-rouge">do_initcalls()</code>-&gt;<code class="highlighter-rouge">do_initcall_level()</code></p>

<p>而执行的顺序就跟各个宏的定义有关，比如 <code class="highlighter-rouge">pure_initcall</code> 实际上是 <code class="highlighter-rouge">__define_initcall(fn, 0)</code> 所以它会被首先执行，而 <code class="highlighter-rouge">late_initcall</code> 是 <code class="highlighter-rouge">__define_initcall(fn, 7)</code> 所以会最后执行。具体的执行如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static void __init do_initcalls(void)
{
    int level;

    for (level = 0; level &lt; ARRAY_SIZE(initcall_levels) - 1; level++)
        do_initcall_level(level);
}
</code></pre>
</div>

<p><code class="highlighter-rouge">do_initcall_level()</code> 会执行每个 section 内部的所有初始化函数 ：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static void __init do_initcall_level(int level)
{
...
    for (fn = initcall_levels[level]; fn &lt; initcall_levels[level+1]; fn++)
        do_one_initcall(*fn);
}
</code></pre>
</div>

<p><code class="highlighter-rouge">do_initcall_level()</code> 按顺序遍历每个 section 执行所有函数。</p>

<p>两个相关的数组，<code class="highlighter-rouge">initcall_levels</code> 指向了每个 section 的起始地址，也就是第一个函数地址，<code class="highlighter-rouge">initcall_level_names</code> 则将 section 的顺序号（就是 0,1,2,3 这些）和初始化函数的含义关联起来（比如 0 对应 early ，1 对应 core）：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>static initcall_t *initcall_levels[] __initdata = {
    __initcall0_start,
    __initcall1_start,
    __initcall2_start,
    __initcall3_start,
    __initcall4_start,
    __initcall5_start,
    __initcall6_start,
    __initcall7_start,
    __initcall_end,
};

/* Keep these in sync with initcalls in include/linux/init.h */
static char *initcall_level_names[] __initdata = {
    "early",
    "core",
    "postcore",
    "arch",
    "subsys",
    "fs",
    "device",
    "late",
};
</code></pre>
</div>


                

              </div>
              
            </div>
            <!-- JiaThis Button BEGIN -->
            <div class="jiathis_style">
                    <span class="jiathis_txt">分享到：</span>
                        <a class="jiathis_button_qzone">QQ空间</a>
                            <a class="jiathis_button_tsina">新浪微博</a>
                                <a class="jiathis_button_tqq">腾讯微博</a>
                                    <a class="jiathis_button_pocket">Pocket</a>
                                        <a class="jiathis_button_evernote">EverNote</a>
                                            <a class="jiathis_button_linkedin">LinkedIn</a>
                                                <a class="jiathis_button_fb">Facebook</a>
                                                    <a class="jiathis_button_weixin">微信</a>
                                                        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
                                                            <a class="jiathis_counter_style"></a>
            </div>
            <script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
            <!-- JiaThis Button END -->
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/study-notes/2016/07/%E5%BC%80%E5%A7%8B%E8%AE%A4%E7%9C%9F%E5%86%99%E7%AC%94%E8%AE%B0">开始认真写笔记</a></li>
    
    <li><a href="/study-notes/2016/07/%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8%E7%9A%84initcall">内核启动的initcall</a></li>
    
    <li><a href="/study-notes/2016/07/linux%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%88%86%E6%9E%90">Linux网络协议栈分析</a></li>
    
    <li><a href="/study-notes/2016/07/kernel%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">Kernel初始化流程</a></li>
    
    <li><a href="/study-notes/2016/07/linux%E4%B8%8B%E6%8B%A6%E6%88%AA%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95">Linux下拦截系统调用的一种方法</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="/study-notes/tag/工具">工具</a></li>
    
      <li><a href="/study-notes/tag/git">git</a></li>
    
      <li><a href="/study-notes/tag/shell">shell</a></li>
    
      <li><a href="/study-notes/tag/vagrant">vagrant</a></li>
    
      <li><a href="/study-notes/tag/ARM">ARM</a></li>
    
      <li><a href="/study-notes/tag/开发板">开发板</a></li>
    
      <li><a href="/study-notes/tag/beaglebone">beaglebone</a></li>
    
      <li><a href="/study-notes/tag/PPC">PPC</a></li>
    
      <li><a href="/study-notes/tag/android">android</a></li>
    
      <li><a href="/study-notes/tag/Knowledge">Knowledge</a></li>
    
      <li><a href="/study-notes/tag/个人">个人</a></li>
    
      <li><a href="/study-notes/tag/C/C++">C/C++</a></li>
    
      <li><a href="/study-notes/tag/Linux">Linux</a></li>
    
      <li><a href="/study-notes/tag/net">net</a></li>
    
      <li><a href="/study-notes/tag/RaspberryPi">RaspberryPi</a></li>
    
      <li><a href="/study-notes/tag/RTOS">RTOS</a></li>
    
      <li><a href="/study-notes/tag/u-boot">u-boot</a></li>
    
      <li><a href="/study-notes/tag/文件系统">文件系统</a></li>
    
      <li><a href="/study-notes/tag/协议栈">协议栈</a></li>
    
      <li><a href="/study-notes/tag/驱动">驱动</a></li>
    
      <li><a href="/study-notes/tag/Kernel">Kernel</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    

  </div>

      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Ezio &copy; 2016</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="oska874 on Github" href="https://github.com/oska874" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="1294322 on StackOverflow" href="http://stackoverflow.com/users/1294322" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="oska874 on LinkedIn" href="https://www.linkedin.com/in/zhang-lei-1b41b669" target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
    </li>
  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/study-notes/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
